<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="data.js"></script>
    
    <style>
        body {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            -webkit-overflow-scrolling: touch;/* 解决ios滑动不流畅问题 */
        }
    </style>
</head>

<body>
    <div class="mui-scroll-wrapper mui-content bg-gray">
        <div class="message"></div>
        <footer class="mui-bar mui-bar-tab">
            <div class="action">
                <!-- <form action=""> -->
                <input type="text" class="margin-l-26" />
                <!-- </form> -->
                <span id="test-send" class="mui-icon mui-icon-plus margin-h-26"></span>
            </div>
        </footer>
    </div>
    <!-- <p class="time">  
            {{item}}
                                <span>{{ item.content.create_time| dateFormat 'hh:mm' }}</span>
                            </p>
            
                            <div class="{{ item.self ? 'self':'' }}">
                                <img class="avatar" src="{{item.self ? userInfo.img : user.img}}" />
                                <div class="text"><p>{{ item.content.msg_body.text }}</p></div>
                            </div> -->
    <script id="test" type="text/html">
        <ul>
            {{each data msgs index}}
               {{ each msgs item index}}
                    {{ each item msg index}}
                    <li>
                        {{if msg.content}}
                            {{msg.content.msg_body.text}}
                        {{/if}}
                    </li>
                    {{/each}}
                {{/each}}
            {{/each}}
        </ul>
    </script>


    <script src="js/rem.js"></script>
    <script src="js/template.js"></script>
    <script src="js/common.js"></script>
    
    <script src="js/mui.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/jmessage-sdk-web.2.6.0.min.js"></script>
    <script>
   
        window.JIM = new JMessage({
            debug: true
        });
        var appkey = '5244aea56672ae685d799270';

        function init() {
            JIM.init({
                "appkey": '4f7aef34fb361292c566a1cd',
                "random_str": "404",
                "signature": '7db047a67a9d7293850ac69d14cc82bf',
                "timestamp": 1507882399401,
                "flag": 1

            }).onSuccess(function (data) {
                console.log('init success:----------------------------------')
                console.log(data);
            }).onFail(function (data) {
                console.log('error:' + JSON.stringify(data))
            });
        }

        init();

        // 初始化状态成功后 再进行后续操作
        setTimeout(function () {
            if (JIM.isInit()) {
                register();
            }
        }, 1000)


        function register() {
            JIM.register({
                'username': 'xuqijin110',
                'password': '123456',
                'nickname': 'nickname'
            }).onSuccess(function (data) {
                console.log('register success:----------------------------------')
                console.log(data);
            }).onFail(function (data) {
                console.log(data)
            });
        }

        setTimeout(function () {
            if (JIM.isInit() && !JIM.isLogin()) {
                login();
            }
        }, 1000)


        function login() {
            JIM.login({
                'username': 'xuqijin110',
                'password': '123456'
            }).onSuccess(function (data) {
                console.log('login success:----------------------------------')
                console.log(data);

                JIM.onMsgReceive(function (data) {
                    console.log('onMsgReceive接受消息:----------------------------------')
                    // console.log(data.messages)
                });
                JIM.onSyncConversation(function (data) {
                    console.log('onSyncConversation接受离线消息:----------------------------------')

                    console.log(data)
                    $('.message').append(template('test', {
                        data: data
                    }));
                })

                // JIM.onEventNotification(function (data) {
                //     console.log('event_receive: ' + JSON.stringify(data));
                // });

                // JIM.onSyncConversation(function (data) { //离线消息同步监听
                //     console.log(data);
                // });

                // JIM.onUserInfUpdate(function (data) {
                //     console.log('onUserInfUpdate : ' + JSON.stringify(data));
                // });

                // JIM.onSyncEvent(function (data) {
                //     console.log('onSyncEvent : ' + JSON.stringify(data));
                // });

                // JIM.onMsgReceiptChange(function (data) {
                //     console.log('onMsgReceiptChange : ' + JSON.stringify(data));

                // });

                // JIM.onSyncMsgReceipt(function (data) {
                //     console.log('onSyncMsgReceipt : ' + JSON.stringify(data));

                // });

                // JIM.onMutiUnreadMsgUpdate(function (data) {
                //     console.log('onConversationUpdate : ' + JSON.stringify(data));
                // });

                // JIM.onTransMsgRec(function (data) {
                //     console.log('onTransMsgRec : ' + JSON.stringify(data));
                // });

                // JIM.onRoomMsg(function (data) {
                //     console.log('onRoomMsg  : ' + JSON.stringify(data));
                // });

            }).onFail(function (data) {

                console.log('error:' + JSON.stringify(data));
            }).onTimeout(function (data) {
                console.log('timeout:' + JSON.stringify(data));
            });
        }
    </script>
</body>

</html>